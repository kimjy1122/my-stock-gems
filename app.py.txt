import streamlit as st
from pykrx import stock
import FinanceDataReader as fdr
import pandas_ta as ta
from datetime import datetime, timedelta
import pandas as pd

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(page_title="Stock Gems", page_icon="ğŸ’", layout="wide")

st.title("ğŸ’ My Stock Gems Scanner")
st.sidebar.header("ì„¤ì •")

# --- ë¶„ì„ ì˜µì…˜ (ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ì¡°ì ˆ ê°€ëŠ¥) ---
rsi_limit = st.sidebar.slider("ìµœì†Œ RSI ê°•ë„", 40, 70, 50)
market_type = st.sidebar.selectbox("ì‹œì¥ ì„ íƒ", ["KOSPI", "KOSDAQ"])

@st.cache_data(ttl=3600) # 1ì‹œê°„ ë™ì•ˆ ë¶„ì„ ê²°ê³¼ ìœ ì§€ (ì„œë²„ ë¶€í•˜ ë°©ì§€)
def run_analysis(m_type):
    today = datetime.now().strftime("%Y%m%d")
    # 1. ìˆ˜ê¸‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    df_investor = stock.get_market_net_purchase_of_equities_by_ticker(today, today, m_type)
    # ì™¸ì¸/ê¸°ê´€ ë™ë°˜ ë§¤ìˆ˜ ì¢…ëª©
    candidates = df_investor[(df_investor['ì™¸êµ­ì¸'] > 0) & (df_investor['ê¸°ê´€í•©ê³„'] > 0)]
    
    gems = []
    # ë¶„ì„ ì†ë„ë¥¼ ìœ„í•´ ìƒìœ„ 20ê°œë§Œ ì •ë°€ ë¶„ì„
    for ticker in candidates.index[:20]:
        try:
            df = fdr.DataReader(ticker, (datetime.now() - timedelta(days=60)).strftime('%Y-%m-%d'))
            df['RSI'] = ta.rsi(df['Close'], length=14)
            df['MA20'] = ta.sma(df['Close'], length=20)
            
            curr = df.iloc[-1]
            if curr['RSI'] >= rsi_limit and curr['Close'] > curr['MA20']:
                name = stock.get_market_ticker_name(ticker)
                gems.append({
                    "ì¢…ëª©ëª…": name,
                    "ì½”ë“œ": ticker,
                    "í˜„ì¬ê°€": int(curr['Close']),
                    "RSI": round(curr['RSI'], 1),
                    "ì™¸ì¸ë§¤ìˆ˜": df_investor.loc[ticker, 'ì™¸êµ­ì¸'],
                    "ê¸°ê´€ë§¤ìˆ˜": df_investor.loc[ticker, 'ê¸°ê´€í•©ê³„']
                })
        except:
            continue
    return pd.DataFrame(gems)

# --- ë©”ì¸ í™”ë©´ ì‹¤í–‰ ---
if st.button('ğŸš€ ì§€ê¸ˆ ì¢…ëª© ë¶„ì„ ì‹œì‘'):
    with st.spinner('ì‹¤ì‹œê°„ ìˆ˜ê¸‰ ë° ì°¨íŠ¸ ë¶„ì„ ì¤‘...'):
        result_df = run_analysis(market_type)
        
        if not result_df.empty:
            st.success(f"ì˜¤ëŠ˜ì˜ {market_type} Gemsë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!")
            
            # ë³´ê¸° ì¢‹ê²Œ í‘œë¡œ ì¶œë ¥
            st.dataframe(result_df.style.highlight_max(axis=0, subset=['RSI']), use_container_width=True)
            
            # ê°œë³„ ì¢…ëª© ì¹´ë“œ í˜•íƒœë¡œ ì¶œë ¥ (ëª¨ë°”ì¼ ìµœì í™”)
            for _, row in result_df.iterrows():
                with st.expander(f"ğŸ“ˆ {row['ì¢…ëª©ëª…']} ({row['ì½”ë“œ']}) ìƒì„¸ ë³´ê¸°"):
                    st.write(f"**í˜„ì¬ê°€:** {row['í˜„ì¬ê°€']:,}ì›")
                    st.write(f"**ìƒìŠ¹ì—ë„ˆì§€(RSI):** {row['RSI']}")
                    st.write(f"**ìˆ˜ê¸‰:** ì™¸ì¸ {row['ì™¸ì¸ë§¤ìˆ˜']:,} / ê¸°ê´€ {row['ê¸°ê´€í•©ê³„']:,}")
        else:
            st.warning("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì˜µì…˜ì„ ì¡°ì ˆí•˜ê±°ë‚˜ ì¥ ë§ˆê° í›„ì— ì‹œë„í•˜ì„¸ìš”.")